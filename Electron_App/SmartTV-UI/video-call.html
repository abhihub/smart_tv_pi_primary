<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Video Call | Smart Family Console</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="tv-remote.css">
    <script>
        // Config will be injected by main process - no fallback values
        console.log('Waiting for config from main process:', window.appConfig);
    </script>
    <script src="https://sdk.twilio.com/js/video/releases/2.23.0/twilio-video.min.js"></script>
    <link rel="stylesheet" href="css/video-call.css"></head>

<body>
    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-left">
            <div class="user-info">ID: <span id="userIdDisplay">Loading...</span></div>
        </div>
        <div class="status-center">
            <div class="current-time" id="currentTime">11:35</div>
        </div>
        <div class="status-right">
            <div class="ip-info">Mobile: <span id="deviceIPDisplay">Loading...</span></div>
            <div class="battery-icon">ðŸ”‹</div>
        </div>
    </div>

    <!-- Background floating effects -->
    <div class="floating-effect"></div>
    <div class="floating-effect"></div>

    <!-- Status Messages -->
    <div class="status-message" id="statusMessage"></div>

    <!-- Connection UI -->
    <div class="connection-ui" id="connectionUI">
        <div>
            <a href="#" class="back-btn" id="backToConsoleBtn">
                <i class="fas fa-arrow-left"></i> Back to Console
            </a>
        </div>
        <div class="connection-card">
            <!-- Auto-connecting interface (shown when coming from call flow) -->
            <div id="autoConnectUI" style="display: none;">
                <h1 class="connection-title">ðŸ“ž Connecting to Call</h1>
                
                <div style="text-align: center; margin: 40px 0;">
                    <div class="connection-spinner"></div>
                    <h2 id="callParticipants" style="margin: 20px 0; font-size: 1.5rem;">
                        Connecting...
                    </h2>
                    <p id="callStatus" style="opacity: 0.8; font-size: 1.1rem;">
                        Setting up video call
                    </p>
                </div>

                <div class="call-info-display">
                    <div class="info-item">
                        <span class="info-label">Room:</span>
                        <span id="displayRoomName">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Your ID:</span>
                        <span id="displayUserName">Loading...</span>
                    </div>
                </div>
            </div>

           <!-- Hidden input fields for backend compatibility -->
        <input type="hidden" id="userName" value="Family Member">
       <input type="hidden" id="roomName" value="family-room">
        </div>
    </div>

    <!-- Header -->
    <div class="call-header" style="display: none;" id="callHeader">
        <div class="call-info">
            <div class="call-duration"><i class="fas fa-clock"></i> <span id="callTimer">00:00</span></div>
            <div class="participant-count"><i class="fas fa-users"></i> <span id="participantCount">1</span>
                participants</div>
        </div>
    </div>

    <!-- Video Grid -->
    <div class="video-container" id="videoContainer" style="display: none;">
        <!-- Self View
        <div class="self-view">
            <video id="selfVideo" autoplay playsinline></video>
        </div> -->
    </div>

    <!-- Controls -->
    <div class="controls" id="controls" style="display: none;">
        <div class="control-btn" id="muteBtn" data-focusable="true" tabindex="0">
            <div class="btn-circle">
                <i class="fas fa-microphone"></i>
            </div>
            <div class="btn-label">Mute</div>
        </div>

        <div class="control-btn" id="videoBtn" data-focusable="true" tabindex="0">
            <div class="btn-circle">
                <i class="fas fa-video"></i>
            </div>
            <div class="btn-label">Video</div>
        </div>


        <div class="control-btn" id="effectsBtn" data-focusable="true" tabindex="0">
            <div class="btn-circle">
                <i class="fas fa-magic"></i>
            </div>
            <div class="btn-label">Effects</div>
        </div>

        <div class="control-btn btn-danger" id="endCallBtn" data-focusable="true" tabindex="0">
            <div class="btn-circle">
                <i class="fas fa-phone"></i>
            </div>
            <div class="btn-label">End Call</div>
        </div>
    </div>
    <script src="video-call.js"></script>
    <script src="user-utils.js"></script>
    <script src="tv-remote.js"></script>
    <script>
        // Initialize TV remote for video call controls
        document.addEventListener('DOMContentLoaded', () => {
            if (window.tvRemote) {
                // Set linear navigation for video call controls
                window.tvRemote.setGridColumns(4); // 4 controls in a row
                
                // Enable stable mode to prevent focus loss during video calls
                window.tvRemote.enableStableMode();
                
                console.log('ðŸŽ® TV Remote initialized for video call with stable mode');
            }
        });
    </script>
    <script src="universal-navigation.js"></script>
    <script>
        // Update time in status bar
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit', 
                hour12: false 
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        // Update time immediately and then every minute
        updateTime();
        setInterval(updateTime, 60000);

        // Display user ID and device IP
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const currentUser = await getCurrentUser();
                const userIdElement = document.getElementById('userIdDisplay');
                
                if (currentUser && currentUser.username) {
                    userIdElement.textContent = currentUser.username;
                } else {
                    userIdElement.textContent = 'Not Set';
                }
            } catch (error) {
                console.error('Error displaying user ID:', error);
                document.getElementById('userIdDisplay').textContent = 'Error';
            }

            try {
                const connectionInfo = await window.electronAPI.getConnectionInfo();
                const deviceIPElement = document.getElementById('deviceIPDisplay');
                if (connectionInfo) {
                    deviceIPElement.textContent = `${connectionInfo.ip}:${connectionInfo.port}`;
                }
            } catch (error) {
                console.error('Error getting connection info:', error);
                document.getElementById('deviceIPDisplay').textContent = 'IP not available';
            }
        });
    </script>
</body>

</html>