<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect Mobile Remote - SmartTV</title>
    <link rel="stylesheet" href="css/qr-connection.css"></head>
<body>
    <div class="qr-overlay">
        <div class="qr-container">
            <button class="close-button" onclick="closeQROverlay()">×</button>
            
            <div class="qr-header">
                <h1 class="qr-title">📱 Connect Mobile Remote</h1>
                <p class="qr-subtitle">Scan this QR code with your SmartTV Remote app to connect</p>
            </div>

            <div class="qr-code-wrapper">
                <div class="loading-spinner" id="qrLoading"></div>
                <img id="qrCodeImage" class="qr-code" style="display: none;" alt="Connection QR Code">
            </div>

            <div class="connection-info" id="connectionInfo" style="display: none;">
                <div class="info-row">
                    <span class="info-label">Device IP:</span>
                    <span class="info-value" id="deviceIP">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Port:</span>
                    <span class="info-value">8080</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Status:</span>
                    <span class="info-value">Waiting for connection</span>
                </div>
            </div>

            <div class="instructions">
                <h3>🔗 How to Connect:</h3>
                <ol>
                    <li>Open the <strong>SmartTV Remote</strong> app on your phone</li>
                    <li>Tap the <strong>"Scan QR Code"</strong> button</li>
                    <li>Point your camera at the QR code above</li>
                    <li>Wait for automatic connection</li>
                </ol>
            </div>

            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>Remote server is running and ready for connections</span>
            </div>
        </div>
    </div>

    <script>
        // Generate and display QR code on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('🎮 QR Connection page loaded');
            await generateConnectionQR();
        });

        async function generateConnectionQR() {
            try {
                console.log('📱 Generating connection QR code...');
                
                // Get device IP and connection info from main process
                const connectionData = await window.electronAPI.getConnectionInfo();
                console.log('📋 Connection data:', connectionData);
                
                // Display device IP
                document.getElementById('deviceIP').textContent = connectionData.ip;
                
                // Generate QR code
                const qrData = JSON.stringify({
                    type: 'smarttv_connection',
                    ip: connectionData.ip,
                    port: connectionData.port,
                    device_name: connectionData.device_name,
                    version: connectionData.version,
                    timestamp: Date.now()
                });
                
                console.log('🔗 QR Data:', qrData);
                
                const qrCodeDataURL = await window.electronAPI.generateQRCode(qrData);
                
                // Display QR code
                const qrImage = document.getElementById('qrCodeImage');
                const qrLoading = document.getElementById('qrLoading');
                const connectionInfo = document.getElementById('connectionInfo');
                
                qrImage.src = qrCodeDataURL;
                qrImage.style.display = 'block';
                qrLoading.style.display = 'none';
                connectionInfo.style.display = 'block';
                
                console.log('✅ QR code generated and displayed');
                
            } catch (error) {
                console.error('❌ Error generating QR code:', error);
                
                const qrLoading = document.getElementById('qrLoading');
                qrLoading.innerHTML = '❌ Error generating QR code';
            }
        }

        function closeQROverlay() {
            console.log('🚫 Closing QR overlay');
            window.electronAPI.closeQROverlay();
        }

        // Listen for connection events
        window.electronAPI.onMobileConnected((deviceInfo) => {
            console.log('📱 Mobile device connected:', deviceInfo);
            
            // Update status
            const statusElement = document.querySelector('.status-indicator span');
            statusElement.textContent = `✅ Connected to ${deviceInfo.userAgent || 'mobile device'}`;
            statusElement.style.color = '#00ff88';
            
            // Auto-close after 2 seconds
            setTimeout(() => {
                closeQROverlay();
            }, 2000);
        });
    </script>
</body>
</html>