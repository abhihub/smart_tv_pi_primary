<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incoming Call - SmartTV</title>
    <link rel="stylesheet" href="css/incoming-call.css"></head>
<body>
    <!-- Background animation -->
    <div class="ringing-animation">
        <div class="ring-wave"></div>
        <div class="ring-wave"></div>
        <div class="ring-wave"></div>
        <div class="ring-wave"></div>
    </div>

    <!-- Status message -->
    <div class="status-message" id="statusMessage"></div>

    <!-- Main call interface -->
    <div class="call-container" id="callContainer">
        <div class="incoming-label">Incoming Call</div>
        
        <div class="caller-avatar" id="callerAvatar">?</div>
        
        <div class="caller-name" id="callerName">Unknown Caller</div>
        <div class="caller-subtitle">Calling from Smart TV</div>
        
        <div class="call-actions">
            <div style="text-align: center;">
                <button class="action-btn answer-btn call-btn" data-focusable="true" id="answerBtn" onclick="answerCall()">
                    üìû
                </button>
                <div class="action-label">Answer</div>
            </div>
            
            <div style="text-align: center;">
                <button class="action-btn decline-btn call-btn" data-focusable="true" id="declineBtn" onclick="declineCall()">
                    ‚ùå
                </button>
                <div class="action-label">Decline</div>
            </div>
        </div>
    </div>

    <!-- Loading state -->
    <div class="loading" id="loadingState">
        <div class="spinner"></div>
        <div>Processing call...</div>
    </div>

    <script src="config.js"></script>
    <script src="user-utils.js"></script>
    <script src="tv-remote.js"></script>
    <script src="universal-navigation.js"></script>
    <script>
        let callId = null;
        let callerUsername = null;
        let currentUser = null;

        // Get server URL from config - waits for config to be ready
        async function getServerUrl() {
            // Try electronAPI first (preload script)
            if (window.electronAPI?.getAppConfig) {
                const config = window.electronAPI.getAppConfig();
                if (config?.SERVER_URL) {
                    return config.SERVER_URL;
                }
            }
            
            // Try window.appConfig (main process injection)
            if (window.appConfig?.SERVER_URL) {
                return window.appConfig.SERVER_URL;
            }
            
            // Wait for config to be ready
            return new Promise((resolve) => {
                const checkConfig = () => {
                    // Check electronAPI again
                    if (window.electronAPI?.getAppConfig) {
                        const config = window.electronAPI.getAppConfig();
                        if (config?.SERVER_URL) {
                            resolve(config.SERVER_URL);
                            return;
                        }
                    }
                    
                    // Check window.appConfig again
                    if (window.appConfig?.SERVER_URL) {
                        resolve(window.appConfig.SERVER_URL);
                        return;
                    }
                    
                    // Wait a bit and try again
                    setTimeout(checkConfig, 100);
                };
                
                // Also listen for configReady event
                window.addEventListener('configReady', (event) => {
                    if (event.detail?.SERVER_URL) {
                        resolve(event.detail.SERVER_URL);
                    }
                }, { once: true });
                
                checkConfig();
            });
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Get call details from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                callId = urlParams.get('call_id');
                callerUsername = urlParams.get('caller');

                if (!callId || !callerUsername) {
                    showStatusMessage('Invalid call information', true);
                    setTimeout(() => {
                        window.location.href = 'homepage.html';
                    }, 3000);
                    return;
                }

                // Get current user
                currentUser = await getCurrentUser();
                if (!currentUser) {
                    showStatusMessage('User not found', true);
                    setTimeout(() => {
                        window.location.href = 'homepage.html';
                    }, 3000);
                    return;
                }

                // Display caller information
                displayCallerInfo();

                // Set up keyboard shortcuts
                setupKeyboardShortcuts();

                // Auto-decline after 30 seconds
                setTimeout(() => {
                    if (callId) {
                        showStatusMessage('Call timeout - automatically declining');
                        declineCall();
                    }
                }, 30000);

            } catch (error) {
                console.error('Failed to initialize incoming call:', error);
                showStatusMessage('Error loading call', true);
            }
        });

        function displayCallerInfo() {
            document.getElementById('callerName').textContent = callerUsername;
            document.getElementById('callerAvatar').textContent = callerUsername.substring(0, 2);
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case 'Enter':
                    case ' ':
                        e.preventDefault();
                        answerCall();
                        break;
                    case 'Escape':
                        e.preventDefault();
                        declineCall();
                        break;
                }
            });
        }

        async function answerCall() {
            if (!callId || !currentUser) return;

            try {
                showLoading();
                showStatusMessage('Answering call...');

                const serverUrl = await getServerUrl();
                const response = await fetch(`${serverUrl}/api/calls/answer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        call_id: callId,
                        callee: currentUser.username
                    })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to answer call');
                }

                showStatusMessage('Call accepted - joining video call...');

                // Redirect to video call with room information
                const roomName = data.call.room_name;
                window.location.href = `video-call.html?room=${roomName}&caller=${callerUsername}&callee=${currentUser.username}&answered=true`;

            } catch (error) {
                console.error('Failed to answer call:', error);
                hideLoading();
                showStatusMessage(`Failed to answer call: ${error.message}`, true);
            }
        }

        async function declineCall() {
            if (!callId || !currentUser) return;

            try {
                showLoading();
                showStatusMessage('Declining call...');

                const serverUrl = await getServerUrl();
                const response = await fetch(`${serverUrl}/api/calls/decline`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        call_id: callId,
                        callee: currentUser.username
                    })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to decline call');
                }

                showStatusMessage('Call declined');
                
                // Clear call ID to prevent auto-decline
                callId = null;

                // Redirect back to homepage after brief delay
                setTimeout(() => {
                    window.location.href = 'homepage.html';
                }, 2000);

            } catch (error) {
                console.error('Failed to decline call:', error);
                hideLoading();
                showStatusMessage(`Failed to decline call: ${error.message}`, true);
            }
        }

        function showLoading() {
            document.getElementById('callContainer').style.display = 'none';
            document.getElementById('loadingState').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('callContainer').style.display = 'block';
            document.getElementById('loadingState').style.display = 'none';
        }

        function showStatusMessage(message, isError = false) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.style.background = isError ? 
                'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)' : 
                'rgba(0, 0, 0, 0.8)';
            statusElement.classList.add('show');

            // Auto-hide after 3 seconds
            setTimeout(() => {
                statusElement.classList.remove('show');
            }, 3000);
        }

        // Handle page visibility change (in case user switches tabs)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && callId) {
                // Page became visible again, check if call is still active
                console.log('Page visible again, call still active');
            }
        });

        // Clean up if user navigates away
        window.addEventListener('beforeunload', (e) => {
            if (callId) {
                // Attempt to decline call if user navigates away
                declineCall();
            }
        });
    </script>
</body>
</html>